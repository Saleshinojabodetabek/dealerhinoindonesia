# =========================================
# ðŸ”’ DealerHinoIndonesia - SECURITY CONFIG (FINAL)
# =========================================

# 1) Basic
Options -Indexes
RewriteEngine On

# 2) Force HTTPS (except localhost for dev)
RewriteCond %{HTTP_HOST} !^localhost [NC]
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# =========================================
# âœ” Allow essential static files (bypass rewrites/blocks)
# =========================================
# Allow favicon regardless of Referer
RewriteRule (^|/)favicon\.(ico|png|gif|jpg|jpeg|webp)$ - [L,NC]
# Allow PWA / manifests
RewriteRule ^(manifest\.json|site\.webmanifest)$ - [L,NC]
# Allow sitemap & robots
RewriteRule ^(sitemap\.xml|robots\.txt)$ - [L,NC]

# =========================================
# ðŸ”¥ ANTI-HOTLINK GAMBAR (LOGIKA BENAR: cek referer ada AND bukan domain kita)
# =========================================
RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{REQUEST_URI} \.(?:jpe?g|png|gif|webp)$ [NC]
RewriteCond %{HTTP_REFERER} !^$                       [AND]
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?dealerhinoindonesia\.com [NC]
RewriteRule \.(?:jpe?g|png|gif|webp)$ - [F,NC,L]

# =========================================
# Block access to sensitive files (modern syntax)
# =========================================
<IfModule mod_authz_core.c>
  <FilesMatch "(^\.|config\.php|koneksi\.php|composer\.json|composer\.lock|package\.json|yarn\.lock|\.env|\.git|\.htpasswd)$">
      Require all denied
  </FilesMatch>
</IfModule>

# If mod_authz_core not present, fallback (compat)
<IfModule !mod_authz_core.c>
  <FilesMatch "(^\.|config\.php|koneksi\.php|composer\.json|composer\.lock|package\.json|yarn\.lock|\.env|\.git|\.htpasswd)$">
      Order allow,deny
      Deny from all
  </FilesMatch>
</IfModule>

# =========================================
# Prevent execution of PHP/etc inside admin uploads (but allow static images)
# Use <If> to match URI since <Directory> isn't allowed in .htaccess
# =========================================
<If "%{REQUEST_URI} =~ m#^/admin/api/uploads/#">
  <FilesMatch "\.(php|php3|php4|php5|phtml|phps|pl|py|jsp|asp|aspx|sh|exe)$">
    Require all denied
  </FilesMatch>
</If>

# =========================================
# Block dangerous uploaded filetypes everywhere
# =========================================
<IfModule mod_authz_core.c>
  <FilesMatch "\.(phps|php5|phtml|exe|sh|bat|pl|py|jsp|asp)$">
      Require all denied
  </FilesMatch>
</IfModule>

# =========================================
# Block suspicious query strings (LFI/RFI/injection patterns)
# =========================================
RewriteCond %{QUERY_STRING} (?:\.\./|\.\.\\|/etc/passwd|/bin/bash|base64_encode|eval\(|system\(|shell_exec\(|UNION(?:\s)+SELECT|GLOBALS|_REQUEST) [NC]
RewriteRule .* - [F,L]

# NOTE: removed "single-letter query" blocking because many apps use ?id=123

# =========================================
# Protect .htaccess itself
# =========================================
<Files ".htaccess">
  Require all denied
</Files>

# =========================================
# Block known bad referers & scanners (but allow major crawlers)
# =========================================
SetEnvIfNoCase Referer "semalt\.com" bad_ref=1
SetEnvIfNoCase Referer "buttons\-for\-website" bad_ref=1
SetEnvIfNoCase Referer "darodar\.com" bad_ref=1

SetEnvIfNoCase User-Agent "nikto" bad_bot
SetEnvIfNoCase User-Agent "sqlmap" bad_bot
SetEnvIfNoCase User-Agent "fimap" bad_bot
SetEnvIfNoCase User-Agent "fuzzer" bad_bot

<RequireAll>
  Require all granted
  Require not env bad_ref
  Require not env bad_bot
</RequireAll>

# =========================================
# Optional: Block specific suspicious IP ranges (edit as needed)
# =========================================
<RequireAll>
  Require all granted
  Require not ip 45.146.165.0/24
  Require not ip 185.220.100.0/22
  Require not ip 91.240.118.0/23
</RequireAll>

# =========================================
# Security headers (HSTS, CSP, XSS protections)
# Adjust CSP sources to match third-party services you use (GTM, GA, fonts)
# =========================================
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set X-XSS-Protection "1; mode=block"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
  Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
  Header unset X-Powered-By

  # Minimal CSP (allow GTM, GA, Google Fonts). Modify if you add other third-party scripts.
  Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://www.google.com; img-src 'self' data: https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;"
</IfModule>

# =========================================
# Expires / Cache control (performance)
# =========================================
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresDefault "access plus 3 days"
</IfModule>

# Do not cache PHP/HTML (dynamic)
<FilesMatch "\.(php|html)$">
  <IfModule mod_headers.c>
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
  </IfModule>
</FilesMatch>

# =========================================
# Prevent TRACE requests
# =========================================
RewriteCond %{REQUEST_METHOD} ^TRACE
RewriteRule .* - [F]

# =========================================
# CLEAN URL (remove .php) - keep admin intact
# =========================================
# Redirect requests for .php to no-extension (for SEO)
RewriteCond %{THE_REQUEST} \s/([^\s]+)\.php[\s?] [NC]
RewriteCond %{REQUEST_URI} !^/admin
RewriteRule ^ %1 [R=301,L]

# Serve file.php when user requests /file (frontend only, not /admin)
RewriteCond %{REQUEST_URI} !^/admin
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^([^/]+)/?$ $1.php [L,QSA]

# =========================================
# End
# =========================================
