###############################################

# üåê FRONTEND SECURITY + SEO + PERFORMANCE

###############################################

Options -Indexes
RewriteEngine On

###############################################

# 1) FORCE HTTPS (kecuali localhost)

###############################################
RewriteCond %{HTTP_HOST} !^localhost [NC]
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

###############################################

# 2) ALLOW FAVICON & STATIC SEO FILES

###############################################
RewriteRule (^|/)favicon\.(ico|png|gif|jpg|jpeg|webp|svg)$ - [L,NC]
RewriteRule ^(manifest\.json|site\.webmanifest)$ - [L,NC]
RewriteRule ^(robots\.txt|sitemap.\*)$ - [L,NC]

###############################################

# 3) ANTI-HOTLINK GAMBAR

###############################################
RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{REQUEST_URI} \.(jpe?g|png|gif|svg|webp)$ [NC]
RewriteCond %{HTTP_REFERER} !^$ [AND]
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?dealerhinoindonesia\.com [NC]
RewriteRule \.(jpe?g|png|gif|svg|webp)$ - [F,NC,L]

###############################################

# 4) BLOCK SENSITIVE DEV FILES

###############################################
<FilesMatch "(^\.|composer\.json|composer\.lock|package\.json|yarn\.lock|\.env|\.git|\.htpasswd)$">
Require all denied
</FilesMatch>

###############################################

# 5) BLOCK BAD QUERY STRINGS

###############################################
RewriteCond %{QUERY_STRING} (\.\./|/etc/passwd|base64|eval\(|system\(|UNION._SELECT|GLOBALS|\_REQUEST) [NC]
RewriteRule ._ - [F,L]

###############################################

# 6) BLOCK BOTS / REFERRERS

###############################################
SetEnvIfNoCase Referer "semalt" bad_ref
SetEnvIfNoCase Referer "darodar" bad_ref
SetEnvIfNoCase User-Agent "nikto" bad_bot
SetEnvIfNoCase User-Agent "sqlmap" bad_bot

<RequireAll>
  Require all granted
  Require not env bad_ref
  Require not env bad_bot
</RequireAll>

###############################################

# 7) BLOCK AED / RUSSIAN MALICIOUS IP RANGES

###############################################
<RequireAll>
Require all granted
Require not ip 45.146.165.0/24
Require not ip 185.220.100.0/22
Require not ip 91.240.118.0/23
</RequireAll>

###############################################

# 8) SECURITY & SEO HEADERS + FEATHER FIX

###############################################
<IfModule mod_headers.c>
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
Header unset X-Powered-By

# ‚úî FEATHER ICON FIX:

# butuh inline script & svg inline

# tidak berbahaya selama dibatasi hanya di frontend sendiri

Header always set Content-Security-Policy "
default-src 'self';
img-src 'self' data: https://www.googletagmanager.com https://www.google-analytics.com https://\*.dealerhinoindonesia.com;
script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com;
style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
font-src 'self' https://fonts.gstatic.com;
object-src 'none';
base-uri 'self';
form-action 'self';
frame-ancestors 'self';
"
</IfModule>

###############################################

# 9) CACHE + PERFORMANCE BOOST

###############################################
<IfModule mod_expires.c>
ExpiresActive On
ExpiresByType image/webp "access plus 1 year"
ExpiresByType image/jpeg "access plus 1 year"
ExpiresByType image/png "access plus 1 year"
ExpiresByType image/gif "access plus 1 year"
ExpiresByType image/svg+xml "access plus 1 year"
ExpiresByType text/css "access plus 1 month"
ExpiresByType application/javascript "access plus 1 month"
ExpiresDefault "access plus 3 days"
</IfModule>

# PHP/HTML no cache

<FilesMatch "\.(php|html)$">
Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
</FilesMatch>

###############################################

# 10) CLEAN URL SEO FRIENDLY (tidak ganggu admin)

###############################################
RewriteCond %{THE_REQUEST} \s/([^\s]+)\.php[\s?] [NC]
RewriteCond %{REQUEST_URI} !^/admin
RewriteRule ^ %1 [R=301,L]

RewriteCond %{REQUEST_URI} !^/admin
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^([^/]+)/?$ $1.php [L,QSA]

###############################################

# üîö END

###############################################
