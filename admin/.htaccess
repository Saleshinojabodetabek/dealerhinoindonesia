# ================================================
# üîê DealerHinoIndonesia ‚Äì ADMIN MAXIMUM SECURITY
# Termasuk Brute-Force Protection
# ================================================

Options -Indexes
RewriteEngine On

# =================================================
# 1Ô∏è‚É£ Paksa HTTPS
# =================================================
RewriteCond %{HTTPS} off
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]


# =================================================
# 2Ô∏è‚É£ BATAS KUNJUNGAN / BRUTE FORCE PROTECTION
# (Mencegah bot spam login atau brute-force password)
# Limit: 10 request / menit / IP
# =================================================
<IfModule mod_ratelimit.c>
    # Tidak dipakai, mod_ratelimit hanya throttle bandwidth
</IfModule>

<IfModule mod_evasive20.c>
    DOSHashTableSize    2048
    DOSPageCount        10
    DOSPageInterval     60
    DOSSiteCount        150
    DOSSiteInterval     60
    DOSBlockingPeriod   600
</IfModule>

# Fallback jika mod_evasive TIDAK tersedia (shared hosting)
<IfModule mod_rewrite.c>
    # Catat IP yang akses login
    RewriteCond %{REQUEST_URI} ^/admin/login\.php$ [NC]
    RewriteCond %{REQUEST_METHOD} POST
    RewriteCond %{ENV:bad_login_%{REMOTE_ADDR}} >5
    RewriteRule .* - [F]

    # Tambah counter gagal login
    RewriteCond %{REQUEST_URI} ^/admin/login\.php$ [NC]
    RewriteCond %{QUERY_STRING} error=1 [NC]
    RewriteRule .* - [E=bad_login_%{REMOTE_ADDR}:+1]
</IfModule>


# =================================================
# 3Ô∏è‚É£ Batasi metode HTTP (tetap izinkan OPTIONS untuk AJAX)
# =================================================
<LimitExcept GET POST OPTIONS>
  Require all denied
</LimitExcept>


# =================================================
# 4Ô∏è‚É£ Blokir file sensitif admin
# =================================================
<FilesMatch "^(config|function|convert_all_to_webp|webp_loader)\.php$">
  Require all denied
</FilesMatch>


# =================================================
# 5Ô∏è‚É£ Lindungi file .htaccess
# =================================================
<Files ~ "^\.ht">
  Require all denied
</Files>


# =================================================
# 6Ô∏è‚É£ Blokir akses langsung ke semua file PHP kecuali:
#    ‚úî login.php
#    ‚úî logout.php
# =================================================
RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{REQUEST_FILENAME} \.php$
RewriteCond %{THE_REQUEST} !\s/login\.php [NC]
RewriteCond %{THE_REQUEST} !\s/logout\.php [NC]
RewriteRule .* - [F,L]


# =================================================
# 7Ô∏è‚É£ Lindungi folder API admin dari file berbahaya
# (PHP tetap boleh karena diperlukan)
# =================================================
<If "%{REQUEST_URI} =~ m#^/admin/api/#">
  <FilesMatch "\.(phar|pl|py|jsp|asp|aspx|cgi|sh)$">
    Require all denied
  </FilesMatch>
</If>


# =================================================
# 8Ô∏è‚É£ Blokir query berbahaya
# =================================================
RewriteCond %{QUERY_STRING} (base64_encode|eval\(|UNION(\s)+SELECT|GLOBALS|_REQUEST|/etc/passwd) [NC]
RewriteRule .* - [F,L]


# =================================================
# 9Ô∏è‚É£ Proteksi Bot / Scanner / Curl / Wget
# =================================================
RewriteCond %{HTTP_USER_AGENT} (curl|wget|python|libwww|nikto|scan|httrack) [NC]
RewriteRule .* - [F,L]


# =================================================
# üîü Header Keamanan Lengkap
# =================================================
<IfModule mod_headers.c>
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-XSS-Protection "1; mode=block"
  Header always set Referrer-Policy "no-referrer-when-downgrade"
  Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
</IfModule>


# =================================================
# 1Ô∏è‚É£1Ô∏è‚É£ Matikan server signature
# =================================================
ServerSignature Off
